name: Post-Deployment Smoke Tests

on:
  deployment_status:
    # This runs when a deployment status is updated
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment URL'
        required: true
        default: 'https://staging-api.example.com'
        type: string
      skip_health_checks:
        description: 'Skip health checks'
        required: false
        default: false
        type: boolean

jobs:
  smoke-tests:
    if: github.event.deployment_status.state == 'success' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: ${{ github.event.deployment.environment || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'integration-tests/package-lock.json'

      - name: Install dependencies
        run: |
          cd integration-tests
          npm ci

      - name: Install additional dependencies
        run: |
          npm install axios chai

      - name: Determine deployment URL
        id: deployment-url
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "url=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.deployment.environment }}" = "production" ]; then
            echo "url=https://api.example.com" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.deployment.environment }}" = "staging" ]; then
            echo "url=https://staging-api.example.com" >> $GITHUB_OUTPUT
          else
            echo "url=https://dev-api.example.com" >> $GITHUB_OUTPUT
          fi

      - name: Wait for deployment to be ready
        if: github.event_name != 'workflow_dispatch'
        run: |
          echo "Waiting for deployment to be fully ready..."
          sleep 30

      - name: Run health checks
        if: github.event.inputs.skip_health_checks != true
        run: |
          echo "Running initial health checks..."
          DEPLOYMENT_URL=${{ steps.deployment-url.outputs.url }} node integration-tests/smoke/deployment-smoke-test.js --health-only
        continue-on-error: true

      - name: Run deployment smoke tests
        id: smoke-tests
        run: |
          echo "Running deployment smoke tests..."
          DEPLOYMENT_URL=${{ steps.deployment-url.outputs.url }} npm run test:smoke:deployment
        continue-on-error: true

      - name: Generate test report
        if: always()
        run: |
          cd integration-tests
          mkdir -p test-results
          echo "## Deployment Smoke Test Results" > test-results/smoke-report.md
          echo "" >> test-results/smoke-report.md
          echo "**Environment:** ${{ steps.deployment-url.outputs.url }}" >> test-results/smoke-report.md
          echo "**Deployment:** ${{ github.event.deployment.sha || github.sha }}" >> test-results/smoke-report.md
          echo "**Timestamp:** $(date)" >> test-results/smoke-report.md
          echo "" >> test-results/smoke-report.md
          echo "### Test Results" >> test-results/smoke-report.md
          echo "\`\`\`" >> test-results/smoke-report.md
          cat test-results/smoke-output.log >> test-results/smoke-report.md 2>/dev/null || echo "No detailed logs available" >> test-results/smoke-report.md
          echo "\`\`\`" >> test-results/smoke-report.md

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results-${{ github.run_number }}
          path: integration-tests/test-results/

      - name: Notify on failure
        if: steps.smoke-tests.outcome == 'failure'
        run: |
          echo "Smoke tests failed! Deployment may be unstable."
          # Add notification logic here (Slack, email, etc.)

      - name: Update deployment status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.smoke-tests.outcome }}' === 'success' ? 'success' : 'failure';
            const description = status === 'success'
              ? 'Smoke tests passed - deployment verified'
              : 'Smoke tests failed - deployment may be unstable';

            if (context.eventName === 'deployment_status') {
              github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: ${{ github.event.deployment.id }},
                state: status,
                description: description,
                environment: '${{ github.event.deployment.environment }}',
                log_url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
              });
            }

      - name: Comment on related PR (if applicable)
        if: always() && github.event.deployment.payload?.pull_request
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.deployment.payload.pull_request }};
            const status = '${{ steps.smoke-tests.outcome }}' === 'success' ? '‚úÖ PASSED' : '‚ùå FAILED';

            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üöÄ Deployment Smoke Tests ${status}

**Environment:** ${{ steps.deployment-url.outputs.url }}
**Deployment:** ${{ github.event.deployment.sha || github.sha }}

### Results
- **Status:** ${status}
- **Tests Run:** Post-deployment smoke tests
- **Details:** [View Test Results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

${status === '‚ùå FAILED' ? '‚ö†Ô∏è **Action Required:** Please investigate the deployment and fix any issues before proceeding.' : '‚úÖ **Ready for use:** Deployment has passed smoke tests and is ready for production traffic.'}`
            });